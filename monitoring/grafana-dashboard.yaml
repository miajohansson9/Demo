apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: node-label-operator
data:
  dashboard-provider.yaml: |
    apiVersion: 1
    providers:
    - name: 'Default'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      updateIntervalSeconds: 10
      allowUiUpdates: true
      options:
        path: /var/lib/grafana/dashboards
  node-label-operator.json: |
    {
      "title": "Node Label Operator",
      "uid": "node-label-operator",
      "timezone": "browser",
      "schemaVersion": 16,
      "version": 1,
      "refresh": "5s",
      "time": {
        "from": "now-15m",
        "to": "now"
      },
      "panels": [
          {
            "id": 3,
            "title": "Total Labels Applied",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "sum(node_labels_applied_total)",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "value"
            },
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "blue", "value": null}
                  ]
                }
              }
            }
          },
          {
            "id": 4,
            "title": "Handler Executions / min",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
            "targets": [
              {
                "expr": "60 * sum(rate(node_handler_duration_seconds_count[1m]))",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "value"
            },
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "decimals": 1,
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null}
                  ]
                }
              }
            }
          },
          {
            "id": 5,
            "title": "Handler Errors",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
            "targets": [
              {
                "expr": "sum(node_handler_errors_total)",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "value"
            },
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "red", "value": 1}
                  ]
                }
              }
            }
          },
          {
            "id": 6,
            "title": "üè∑Ô∏è Labels Applied (by Node)",
            "description": "Cumulative count of labels applied from storage to nodes",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
            "targets": [
              {
                "expr": "node_labels_applied_total",
                "legendFormat": "{{node}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {"format": "short", "label": "Total Applied", "min": 0, "decimals": 0},
              {"format": "short"}
            ],
            "lines": true,
            "linewidth": 2,
            "fill": 1,
            "steppedLine": true
          },
          {
            "id": 8,
            "title": "üîÑ Labels Synced to Storage",
            "description": "Label changes synced to NodeLabelState CRD",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
            "targets": [
              {
                "expr": "node_labels_synced_total{action=\"added\"}",
                "legendFormat": "{{node}} - added",
                "refId": "A"
              },
              {
                "expr": "node_labels_synced_total{action=\"removed\"}",
                "legendFormat": "{{node}} - removed",
                "refId": "B"
              },
              {
                "expr": "node_labels_synced_total{action=\"changed\"}",
                "legendFormat": "{{node}} - changed",
                "refId": "C"
              }
            ],
            "yaxes": [
              {"format": "short", "label": "Total Synced", "min": 0, "decimals": 0},
              {"format": "short"}
            ],
            "lines": true,
            "linewidth": 2,
            "fill": 1,
            "steppedLine": true
          },
          {
            "id": 7,
            "title": "‚è±Ô∏è Handler Duration (p50 / p95 / p99)",
            "type": "graph",
            "gridPos": {"h": 6, "w": 24, "x": 0, "y": 12},
            "targets": [
              {
                "expr": "histogram_quantile(0.50, sum(rate(node_handler_duration_seconds_bucket[1m])) by (le, handler))",
                "legendFormat": "{{handler}} - p50",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.95, sum(rate(node_handler_duration_seconds_bucket[1m])) by (le, handler))",
                "legendFormat": "{{handler}} - p95",
                "refId": "B"
              },
              {
                "expr": "histogram_quantile(0.99, sum(rate(node_handler_duration_seconds_bucket[1m])) by (le, handler))",
                "legendFormat": "{{handler}} - p99",
                "refId": "C"
              }
            ],
            "yaxes": [
              {"format": "s", "label": "Duration"},
              {"format": "short"}
            ],
            "fill": 1,
            "linewidth": 2
          }
        ]
    }
