apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: node-label-operator
data:
  dashboard-provider.yaml: |
    apiVersion: 1
    providers:
    - name: 'Default'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      updateIntervalSeconds: 10
      allowUiUpdates: true
      options:
        path: /var/lib/grafana/dashboards
  node-label-operator.json: |
    {
      "title": "Node Label Operator",
      "uid": "node-label-operator",
      "timezone": "browser",
      "schemaVersion": 16,
      "version": 1,
      "refresh": "5s",
      "time": {
        "from": "now-15m",
        "to": "now"
      },
      "panels": [
          {
            "id": 2,
            "title": "Nodes Monitored",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "node_label_nodes_monitored",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "value"
            },
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "red", "value": null},
                    {"color": "yellow", "value": 1},
                    {"color": "green", "value": 2}
                  ]
                }
              }
            }
          },
          {
            "id": 3,
            "title": "Total Labels Restored",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
            "targets": [
              {
                "expr": "sum(node_label_labels_restored_total)",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "value"
            },
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "blue", "value": null}
                  ]
                }
              }
            }
          },
          {
            "id": 4,
            "title": "Reconciliations / min",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 0},
            "targets": [
              {
                "expr": "60 * sum(rate(node_label_reconciliation_duration_seconds_count[1m]))",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "value"
            },
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "decimals": 1,
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null}
                  ]
                }
              }
            }
          },
          {
            "id": 5,
            "title": "Errors",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 0},
            "targets": [
              {
                "expr": "node_label_reconciliation_errors_total",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "value"
            },
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "red", "value": 1}
                  ]
                }
              }
            }
          },
          {
            "id": 6,
            "title": "üè∑Ô∏è Labels Restored (by Node & Label)",
            "description": "Cumulative count - line steps up when labels are restored",
            "type": "graph",
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 4},
            "targets": [
              {
                "expr": "node_label_labels_restored_total",
                "legendFormat": "{{node}}: {{label_key}}={{label_value}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {"format": "short", "label": "Total Restores", "min": 0, "decimals": 0},
              {"format": "short"}
            ],
            "lines": true,
            "linewidth": 2,
            "fill": 1,
            "steppedLine": true
          },
          {
            "id": 7,
            "title": "‚è±Ô∏è Reconciliation Duration (p50 / p95 / p99)",
            "type": "graph",
            "gridPos": {"h": 6, "w": 24, "x": 0, "y": 12},
            "targets": [
              {
                "expr": "histogram_quantile(0.50, rate(node_label_reconciliation_duration_seconds_bucket[1m]))",
                "legendFormat": "p50",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.95, rate(node_label_reconciliation_duration_seconds_bucket[1m]))",
                "legendFormat": "p95",
                "refId": "B"
              },
              {
                "expr": "histogram_quantile(0.99, rate(node_label_reconciliation_duration_seconds_bucket[1m]))",
                "legendFormat": "p99",
                "refId": "C"
              }
            ],
            "yaxes": [
              {"format": "ms", "label": "Duration"},
              {"format": "short"}
            ],
            "fill": 1,
            "linewidth": 2
          }
        ]
    }
